<!DOCTYPE html>
<html>
<head>
<title>三体运动模拟器</title>
<style>
canvas {
  border: 1px solid #000;
  float: left;
}
.controls {
  margin: 10px;
  padding: 10px;
  border: 1px solid #ccc;
  overflow: hidden;
}
.param-group {
  margin: 5px 0;
  padding: 5px;
  border: 1px solid #ddd;
}
.body-params {
  margin: 10px 0;
  padding: 10px;
  border: 1px solid #666;
}
.data-panel {
  float: left;
  margin-left: 20px;
  padding: 10px;
  border: 1px solid #999;
  background: #333;
  color: white;
}
.data-body {
  margin: 10px 0;
  padding: 5px;
  border: 1px solid #444;
}
.data-body h4 {
  margin: 0 0 5px 0;
  color: #88f;
}
</style>
</head>
<body>
<div class="controls">
  <button onclick="toggleSimulation()">开始/暂停</button>
  <button onclick="reset()">重置</button>

  <div class="param-group">
    维度:
    <select id="dimension" onchange="reset()">
      <option value="2">2D</option>
      <option value="3">3D</option>
    </select>
    质点数量:
    <select id="bodyCount" onchange="reset()">
      <option value="1">1</option>
      <option value="3">3</option>
    </select>
  </div>

  <div class="param-group">
    引力常数: <input type="number" id="G" value="100" step="10">
    时间步长: <input type="number" id="dt" value="0.01" step="0.01">
  </div>

  <!-- 质点参数面板 -->
  <div class="body-params" id="body1">
    <h4>质点 1</h4>
    颜色: <input type="color" class="color" value="#ff0000">
    质量: <input type="number" class="mass" value="100" step="10">
    位置X: <input type="number" class="posX" value="400" step="10">
    位置Y: <input type="number" class="posY" value="300" step="10">
    <span class="posZContainer">
      位置Z: <input type="number" class="posZ" value="0" step="10">
    </span>
    速度X: <input type="number" class="velX" value="0" step="0.1">
    速度Y: <input type="number" class="velY" value="0" step="0.1">
    <span class="velZContainer">
      速度Z: <input type="number" class="velZ" value="0" step="0.1">
    </span>
  </div>
  
  <div class="body-params" id="body2" style="display: none;">
    <h4>质点 2</h4>
    颜色: <input type="color" class="color" value="#00ff00">
    质量: <input type="number" class="mass" value="100" step="10">
    位置X: <input type="number" class="posX" value="500" step="10">
    位置Y: <input type="number" class="posY" value="300" step="10">
    <span class="posZContainer">
      位置Z: <input type="number" class="posZ" value="0" step="10">
    </span>
    速度X: <input type="number" class="velX" value="0" step="0.1">
    速度Y: <input type="number" class="velY" value="0" step="0.1">
    <span class="velZContainer">
      速度Z: <input type="number" class="velZ" value="0" step="0.1">
    </span>
  </div>

  <div class="body-params" id="body3" style="display: none;">
    <h4>质点 3</h4>
    颜色: <input type="color" class="color" value="#0000ff">
    质量: <input type="number" class="mass" value="100" step="10">
    位置X: <input type="number" class="posX" value="400" step="10">
    位置Y: <input type="number" class="posY" value="200" step="10">
    <span class="posZContainer">
      位置Z: <input type="number" class="posZ" value="0" step="10">
    </span>
    速度X: <input type="number" class="velX" value="0" step="0.1">
    速度Y: <input type="number" class="velY" value="0" step="0.1">
    <span class="velZContainer">
      速度Z: <input type="number" class="velZ" value="0" step="0.1">
    </span>
  </div>
</div>

<div id="dataPanel" class="data-panel"></div>

<canvas id="canvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let isRunning = false;
let bodies = [];

class Body {
  constructor(mass, position, velocity, color) {
    this.mass = mass;
    this.position = position;
    this.velocity = velocity;
    this.color = color;
    this.trail = [];
  }
}

function toggleSimulation() {
  isRunning = !isRunning;
  if (isRunning) update();
}

function reset() {
  // 控制参数面板显示
  const bodyCount = parseInt(document.getElementById('bodyCount').value);
  document.querySelectorAll('.body-params').forEach((el, i) => {
    el.style.display = i < bodyCount ? 'block' : 'none';
  });

  // 维度控制
  const dimension = document.getElementById('dimension').value;
  document.querySelectorAll('.velZContainer, .posZContainer').forEach(container => {
    container.style.display = dimension === '3' ? 'inline' : 'none';
  });

  // 初始化质点
  bodies = [];
  document.querySelectorAll('.body-params').forEach((param, index) => {
    if (index >= bodyCount) return;
    const mass = parseFloat(param.querySelector('.mass').value);
    const posX = parseFloat(param.querySelector('.posX').value);
    const posY = parseFloat(param.querySelector('.posY').value);
    const posZ = parseFloat(param.querySelector('.posZ').value);
    const velX = parseFloat(param.querySelector('.velX').value);
    const velY = parseFloat(param.querySelector('.velY').value);
    const velZ = parseFloat(param.querySelector('.velZ').value);
    const color = param.querySelector('.color').value;
    
    bodies.push(new Body(
      mass,
      {x: posX, y: posY, z: posZ},
      {x: velX, y: velY, z: velZ},
      color
    ));
  });

  // 添加实时位置更新事件
  document.querySelectorAll('.body-params').forEach((param, index) => {
    const updatePosition = () => {
      if (index < bodies.length) {
        bodies[index].position.x = parseFloat(param.querySelector('.posX').value);
        bodies[index].position.y = parseFloat(param.querySelector('.posY').value);
        bodies[index].position.z = parseFloat(param.querySelector('.posZ').value);
      }
    };
    param.querySelectorAll('.posX, .posY, .posZ').forEach(input => {
      input.addEventListener('input', updatePosition);
    });
  });

  createDataPanel();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function update() {
  if (!isRunning) return;

  const G = parseFloat(document.getElementById('G').value);
  const dt = parseFloat(document.getElementById('dt').value);
  const dimension = parseInt(document.getElementById('dimension').value);

  // 计算加速度
  bodies.forEach(body => {
    let ax = 0, ay = 0, az = 0;
    bodies.forEach(other => {
      if (body === other) return;
      const dx = other.position.x - body.position.x;
      const dy = other.position.y - body.position.y;
      const dz = dimension === 3 ? other.position.z - body.position.z : 0;
      const r = Math.sqrt(dx*dx + dy*dy + dz*dz);
      const F = G * other.mass / (r*r + 1e-6);
      
      ax += F * dx / r;
      ay += F * dy / r;
      az += dimension === 3 ? F * dz / r : 0;
    });

    // 更新速度
    body.velocity.x += ax * dt;
    body.velocity.y += ay * dt;
    body.velocity.z += az * dt;
  });

  // 更新位置
  bodies.forEach(body => {
    body.position.x += body.velocity.x * dt;
    body.position.y += body.velocity.y * dt;
    if (dimension === 3) body.position.z += body.velocity.z * dt;

    // 保存轨迹
    body.trail.push({x: body.position.x, y: body.position.y});
    if (body.trail.length > 50) body.trail.shift();
  });

  // 绘制
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  bodies.forEach(body => {
    // 绘制轨迹
    ctx.beginPath();
    body.trail.forEach((pos, i) => {
      const alpha = i / body.trail.length;
      ctx.strokeStyle = `${body.color}${Math.round(alpha * 15).toString(16)}`;
      if (i === 0) ctx.moveTo(pos.x, pos.y);
      else ctx.lineTo(pos.x, pos.y);
    });
    ctx.stroke();

    // 绘制质点
    ctx.fillStyle = body.color;
    ctx.beginPath();
    ctx.arc(body.position.x, body.position.y, Math.cbrt(body.mass)/2, 0, Math.PI*2);
    ctx.fill();
  });

  // 更新数据面板
  bodies.forEach((body, index) => {
    const dataBody = document.querySelector(`[data-index="${index}"]`);
    if (dataBody) {
      dataBody.querySelector('.posX').textContent = body.position.x.toFixed(2);
      dataBody.querySelector('.posY').textContent = body.position.y.toFixed(2);
      if (dimension === 3) {
        dataBody.querySelector('.posZ').textContent = body.position.z.toFixed(2);
      }
    }
  });

  requestAnimationFrame(update);
}

function createDataPanel() {
  const panel = document.getElementById('dataPanel');
  const dimension = parseInt(document.getElementById('dimension').value);
  panel.innerHTML = bodies.map((body, index) => `
    <div class="data-body" data-index="${index}">
      <h4 style="color: ${body.color}">质点 ${index + 1}</h4>
      <div>质量: ${body.mass.toFixed(1)}</div>
      <div>位置X: <span class="posX">${body.position.x.toFixed(2)}</span></div>
      <div>位置Y: <span class="posY">${body.position.y.toFixed(2)}</span></div>
      ${dimension === 3 ? 
        `<div>位置Z: <span class="posZ">${body.position.z.toFixed(2)}</span></div>` 
        : ''}
    </div>
  `).join('');
}

// 初始化
reset();
</script>
</body>
</html>